# BYBOT — торговый бот для Bybit с Telegram-админкой


________________________________

Команды для CLI и бота в телеграмм

/start - Начать работу
/balance BTCUSDT - Проверить баланс
/run sma_cross 2 - Запустить стратегию SMA с риском 2%

Проверить баланс:
bybot check-balance --symbol BTCUSDT 

Запустить стратегию:
bybot run --strategy sma_cross --risk 2

Запустить бэктест:
bybot backtest

Помощь по командам:
bybot --help

________________________________

## Структура проекта

```
BYBOT/
├── README.md
├── requirements.txt
├── .gitignore
├── config.py                # Конфиги (Bybit API, Telegram, параметры)
├── main.py                  # Точка входа (запуск бота и Telegram-админки)
├── bot/
│   ├── __init__.py
│   ├── core/
│   │   ├── trader.py        # Основной цикл торговли
│   │   └── interface.py     # Интерфейсы
│   ├── exchange/
│   │   ├── bybit_api.py     # Работа с Bybit API
│   │   └── endpoints.py     # Перечисления эндпоинтов API
│   ├── strategy/
│   │   ├── strategy_01.py   # Стратегия Volume Spike + VWAP
│   │   └── strategy_02.py   # Стратегия Tick Timer + Cumulative Delta
│   ├── services/
│   │   └── telegram_bot.py  # Telegram-бот
│   ├── state.py             # Хранение позиций, баланса
│   └── cli/                 # CLI интерфейс
├── docs/                    # Документация
├── examples/                # Примеры использования
├── tests/                   # Тесты
├── data/
│   ├── logs/
│   └── trades.csv
├── tests/
│   ├── __init__.py
│   └── test_core.py
└── scripts/
    └── backtest.py
```

## Быстрый старт

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Заполните `config.py` (Bybit API ключи, Telegram токен, id админа)
3. Запустите бота:
   ```bash
   python main.py
   ```

## Торговля деривативами (фьючерсы USDT)

Бот работает с деривативами Bybit (USDT-фьючерсы, category="linear").

### Установка плеча (leverage)
Перед началом торговли вы можете выставить плечо для выбранного инструмента:

```python
from bot.exchange.bybit_api import BybitAPI
api = BybitAPI()
api.set_leverage("BTCUSDT", buy_leverage=1, sell_leverage=1)  # Плечо 1x для лонга и шорта
```

### Размещение ордеров (лонг/шорт)
- Для открытия лонга используйте side="Buy"
- Для открытия шорта используйте side="Sell"

Пример рыночного ордера с установкой стоп-лосс и тейк-профит:
```python
api.create_order(
    symbol="BTCUSDT",
    side="Buy",  # Лонг
    order_type="Market",
    qty=0.01,
    stop_loss=30000,
    take_profit=35000
)
   ```

## Возможности
- Автоматическая торговля на Bybit по выбранной стратегии
- Управление ботом через Telegram (старт/стоп, статус, логи, рассылка)
- Логирование сделок и ошибок
- Гибкая архитектура для расширения
- **Торговля деривативами (фьючерсы USDT), поддержка лонг/шорт, установка плеча, стоп-лосс и тейк-профит**
- **Структурированные перечисления эндпоинтов API для типобезопасности**
- **Улучшенная обработка стоп-лосса и тейк-профита через отдельные запросы**
- **Модульная архитектура с разделением на стратегии, сервисы и CLI**

## Перечисления эндпоинтов API

Проект использует структурированные перечисления для всех эндпоинтов Bybit API v5:

```python
from bot.exchange.endpoints import Position, Trade, Account, Market

# Создание ордера
api._send_request("POST", Trade.PLACE_ORDER, params)

# Получение позиций
api._send_request("GET", Position.GET_POSITIONS, params)

# Установка стоп-лосса
api._send_request("POST", Position.SET_TRADING_STOP, params)
```

### Преимущества:
- ✅ Типобезопасность - IDE проверяет правильность
- ✅ Автодополнение - IDE предлагает доступные эндпоинты  
- ✅ Централизованное управление - все в одном месте
- ✅ Легкость рефакторинга - изменение в одном месте

Подробнее см. [docs/API_ENDPOINTS.md](docs/API_ENDPOINTS.md)

## Управление стратегиями через CLI

Теперь вы можете выбирать активную стратегию для бота прямо из командной строки:

- Установить стратегию:
  ```bash
  bybot set-strategy strategy_01
  ```
- Посмотреть текущую стратегию:
  ```bash
  bybot get_strategy
  ```

Активная стратегия сохраняется в файл `strategy_state.txt` и используется при запуске бота.

## Логирование сигналов стратегий (для ML и анализа)

Каждый сигнал, сгенерированный стратегией, автоматически записывается в файл `data/strategy_signals.csv`.

Поля:
- datetime — дата и время сигнала
- strategy — название стратегии
- symbol — инструмент
- signal — тип сигнала (BUY/SELL/NO SIGNAL)
- market_data — рыночные данные на момент сигнала
- indicators — значения индикаторов
- comment — комментарий/обоснование

Это позволяет анализировать эффективность стратегий, строить ML-модели и оптимизировать торговлю.

## Трейдерский дневник (trades.csv)

Все совершённые сделки (закрытие позиций) автоматически логируются в файл `data/trades.csv` с расширенными полями:
- datetime, symbol, side, qty, entry_price, exit_price, pnl, stop_loss, take_profit, strategy, comment

Можно использовать для анализа, построения отчётов, обучения ML-моделей и ведения истории торговли.

## Зависимости
- pybit
- python-telegram-bot
- python-dotenv
- pandas

---

**Внимание:** Никогда не публикуйте свои API-ключи и токены в открытом доступе! 

## Таймауты и ретраи (устойчивость к ошибкам сети)

В классе BybitAPI реализована поддержка таймаутов и автоматических повторов (ретраев) запросов к API.

- По умолчанию каждый запрос ждёт ответа не более **10 секунд** (timeout).
- При ошибке или таймауте запрос будет повторён до **3 раз** (max_retries).
- Все попытки, таймауты и ошибки логируются в отдельный файл `data/logs/bybit_api.log`.

### Как изменить параметры

Можно изменить параметры для конкретного объекта:
```python
api = BybitAPI()
api.timeout = 5         # Таймаут 5 секунд
api.max_retries = 5     # 5 попыток
```

Или добавить параметры в конструктор (если реализовано):
```python
api = BybitAPI(timeout=5, max_retries=5)
```

**Это повышает надёжность работы бота при временных сетевых сбоях или задержках на стороне Bybit.**

--- 