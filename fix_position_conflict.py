#!/usr/bin/env python3
"""
üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–ê –ü–û–ó–ò–¶–ò–ô

–ü—Ä–æ–±–ª–µ–º–∞: OrderManager –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –æ—Ä–¥–µ—Ä–∞ –∏–∑-–∑–∞ –≤–Ω–µ—à–Ω–µ–π Sell –ø–æ–∑–∏—Ü–∏–∏
–†–µ—à–µ–Ω–∏–µ: –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python fix_position_conflict.py
"""

import os
import shutil
from datetime import datetime

def fix_order_manager():
    """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ OrderManager –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏"""

    order_manager_file = "bot/core/order_manager.py"
    backup_file = f"{order_manager_file}.backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"

    print(f"üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ {order_manager_file}...")

    # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
    shutil.copy2(order_manager_file, backup_file)
    print(f"üíæ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: {backup_file}")

    # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
    with open(order_manager_file, 'r', encoding='utf-8') as f:
        content = f.read()

    # –ó–∞–º–µ–Ω—è–µ–º —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    old_code = '''if not request.reduce_only and current_side != request.side:
                    return False, f"–ö–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π: —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è {current_side}, –∑–∞–ø—Ä–æ—Å {request.side}"'''

    new_code = '''if not request.reduce_only and current_side != request.side:
                    # ‚ö†Ô∏è –í–†–ï–ú–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –†–∞–∑—Ä–µ—à–∞–µ–º —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–∑–∏—Ü–∏–π
                    self.logger.warning(f"‚ö†Ô∏è –í–Ω–µ—à–Ω—è—è –ø–æ–∑–∏—Ü–∏—è {current_side}, –Ω–æ–≤—ã–π –æ—Ä–¥–µ—Ä {request.side} - —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ")
                    # return False, f"–ö–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π: —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è {current_side}, –∑–∞–ø—Ä–æ—Å {request.side}"'''

    if old_code in content:
        content = content.replace(old_code, new_code)

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        with open(order_manager_file, 'w', encoding='utf-8') as f:
            f.write(content)

        print("‚úÖ OrderManager –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!")
        print("üéØ –¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª–Ω—è—Ç—å –æ—Ä–¥–µ—Ä–∞ –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏")
        return True
    else:
        print("‚ùå –ö–æ–¥ –¥–ª—è –∑–∞–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ —Ñ–∞–π–ª —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω.")
        return False

def add_config_options():
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"""

    config_file = "config.py"

    config_addition = '''
# ============================================================================
# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–û–í –ü–û–ó–ò–¶–ò–ô
# ============================================================================

# –†–∞–∑—Ä–µ—à–∏—Ç—å —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–∑–∏—Ü–∏–π
ALLOW_EXTERNAL_HEDGING = True

# –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
IGNORE_EXTERNAL_POSITIONS = True

# –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ä–¥–µ—Ä–æ–≤
WARN_ON_POSITION_CONFLICTS = True
'''

    try:
        with open(config_file, 'a', encoding='utf-8') as f:
            f.write(config_addition)
        print("‚úÖ –û–ø—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ config.py")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ config: {e}")
        return False

def create_restart_script():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã"""

    restart_script = '''#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ–∑–∏—Ü–∏–π..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å
pkill -f "python main.py"
sleep 3

# –û—á–∏—â–∞–µ–º lock —Ñ–∞–π–ª—ã
rm -f .locks/trading_bot_main.lock

# –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–Ω–æ–≤–æ
echo "üöÄ –ó–∞–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã..."
nohup python main.py > restart.log 2>&1 &

echo "‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞!"
echo "üìù –õ–æ–≥–∏: tail -f restart.log"
'''

    with open("restart_after_fix.sh", 'w') as f:
        f.write(restart_script)

    os.chmod("restart_after_fix.sh", 0o755)
    print("‚úÖ –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–æ–∑–¥–∞–Ω: restart_after_fix.sh")

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""

    print("="*60)
    print("üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–ê –ü–û–ó–ò–¶–ò–ô")
    print("="*60)
    print()
    print("üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:")
    print("‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª—ã (85,965 –∑–∞–ø–∏—Å–µ–π)")
    print("‚Ä¢ OrderManager –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ä–¥–µ—Ä–∞ –∏–∑-–∑–∞ –≤–Ω–µ—à–Ω–µ–π Sell –ø–æ–∑–∏—Ü–∏–∏")
    print("‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç: –ª–æ–≥–∏ –µ—Å—Ç—å, —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–µ—Ç")
    print()
    print("üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:")
    print("‚Ä¢ –û—Ç–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤")
    print("‚Ä¢ –†–∞–∑—Ä–µ—à–∏—Ç—å —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–∑–∏—Ü–∏–π")
    print("‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏")
    print()

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    response = input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ? (y/N): ").lower()
    if response != 'y':
        print("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        return

    success = True

    # 1. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º OrderManager
    if not fix_order_manager():
        success = False

    # 2. –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ –∫–æ–Ω—Ñ–∏–≥
    if not add_config_options():
        success = False

    # 3. –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
    create_restart_script()

    print()
    print("="*60)
    if success:
        print("‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!")
        print()
        print("üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        print("1. bash restart_after_fix.sh  # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É")
        print("2. tail -f restart.log        # –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏")
        print("3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã")
        print()
        print("üéØ –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å!")
    else:
        print("‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ê–°–¢–ò–ß–ù–û –ó–ê–í–ï–†–®–ï–ù–û")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é")
    print("="*60)

if __name__ == "__main__":
    main()